# Система аффиксов на слотах заклинаний

## Концепция

Слоты заклинаний выполняют двойную роль:
1. **Слот для заклинания** — как сейчас, в слот экипируется заклинание героя
2. **"Шмотка"** — слот сам по себе является предметом (аналог item в Path of Exile), который можно улучшать орбами

## Аффиксы на слоте

- Каждый слот заклинания имеет **6 аффиксов**
- Изначально все 6 аффиксов — **пустые** (None / no effect). Это упрощает логику орбов: орба всегда "перезаписывает" существующий аффикс, неважно пустой он или нет
- Аффиксы модифицируют **статы главного персонажа** (не заклинания напрямую)
- Каждый аффикс имеет **тир** (уровень силы). У каждого аффикса свой максимальный тир и нелинейные значения, задаваемые гейм-дизайнером
- **Уникальность на слоте:** один и тот же аффикс не может быть на одном слоте дважды, но может присутствовать на разных слотах
- **Пул аффиксов per slot:** у каждого слота свой набор возможных аффиксов (например, атакующие аффиксы только на Active-слоте)

## Тиры аффиксов

У каждого аффикса индивидуальная шкала тиров с нелинейными значениями:

```
Пример: аффикс "% increased damage"
  T1: +8%
  T2: +15%
  T3: +25%
  T4: +40%
  (макс тир у этого аффикса — T4)

Пример: аффикс "+flat damage"
  T1: +3
  T2: +7
  T3: +12
  (макс тир у этого аффикса — T3)
```

Значения и количество тиров для каждого аффикса задаются в RON-файле.

## Орбы (крафт-валюты)

Три орба на старте:

| Орба | Эффект | Цена |
|------|--------|------|
| **Orb of Alteration** | Меняет **1** случайный аффикс на новый случайный | фикс. |
| **Orb of Chaos** | Меняет **3** случайных аффикса на новые случайные | фикс. |
| **Orb of Augmentation** | Повышает тир **1** случайного аффикса на **+1** | фикс. |

- Орбы покупаются в **отдельном разделе магазина**
- Стоимость каждого типа орбы **фиксированная** (не зависит от волны)

### Orb of Alteration / Chaos — правила выбора

- Выбирает случайный слот аффикса (включая пустые)
- Перезаписывает текущий аффикс новым случайным из пула этого слота
- Новый аффикс не может совпадать с уже присутствующими на слоте (уникальность) (те которые меняются - считаются удаленными и могут выпасть сразу снова)
- Тир нового аффикса — T1

### Orb of Augmentation — правила выбора

- Выбирает случайный аффикс **только среди непустых** (пустые игнорируются)
- В первую очередь выбирает среди аффиксов с **не максимальным тиром**
- Если все непустые аффиксы на макс тире — трата впустую (ничего не происходит)
- Если непустых аффиксов нет (все 6 пустые) — тоже трата впустую

## UX-флоу покупки орба

```
1. Игрок покупает орбу в магазине
         ↓
2. Экран выбора слота:
   "На какой слот применить?"
   [ Slot 1 ] [ Slot 2 ] [ Slot 3 ] [ Slot 4 ]
         ↓
3. Орба применяется, открывается экран превью изменений:

   ┌──────────────────────────────────────────┐
   │  Slot 1 — Fireball                       │
   ├──────────────────────────────────────────┤
   │  +5% speed            (белый)   — без изменений  │
   │  +10% fire damage     (красный) — был, удалён    │
   │  +8% max life         (зелёный) — новый           │
   │  [empty]              (белый)   — без изменений  │
   │  [empty]              (белый)   — без изменений  │
   │  [empty]              (белый)   — без изменений  │
   ├──────────────────────────────────────────┤
   │       [ Accept ]    [ Cancel ]           │
   └──────────────────────────────────────────┘
```

### Цветовая индикация
- **Белый** — аффикс не изменился
- **Красный** — аффикс удалён (старое значение)
- **Зелёный** — аффикс добавлен (новое значение)
- У каждого аффикса всегда отображается его тир: `+8% physical damage [T1]`

### Для Orb of Augmentation
- Аффикс показывается **белым**, а новое значение **зелёным**. `+5%→15% speed [T1→T2]` (Т2 и 15% зеленым цветом)

### Кнопки
- **Accept** — применить изменения к слоту. Орба потрачена.
- **Cancel** — отклонить изменения, аффиксы не меняются. **Орба всё равно теряется** (золото потрачено). Это создаёт элемент риска при покупке.

## Влияние на статы

Аффиксы напрямую модифицируют статы героя через существующую систему `ComputedStats` / `StatModifier`. Примеры возможных аффиксов:
- `+X% movement speed`
- `+X flat damage`
- `+X% max life`
- `+X% cast speed`
- `+X% area of effect`

Сумма всех аффиксов со всех 4 слотов складывается в итоговые модификаторы героя.

## Data format

Аффиксы определяются в **RON-файле** (`assets/affixes/config.affixes.ron` или подобное).

Тип модификатора кодируется в имени стата (как уже работает в проекте):
- `*_base` — flat добавка (Sum агрегация)
- `*_increased` — процентное увеличение (Sum, формула: `base * (1 + increased)`)
- `*_more` — мультипликатор (Product агрегация)

Пример структуры:

```ron
(
    affixes: [
        (
            id: "increased_physical_damage",
            name: "+#% physical damage",
            stat: "physical_damage_increased",
            slots: [Active, Passive],
            tiers: [
                (value: 0.08),
                (value: 0.15),
                (value: 0.25),
                (value: 0.40),
            ],
        ),
        (
            id: "flat_max_life",
            name: "+# max life",
            stat: "max_life_base",
            slots: [Active, Passive, Support, Defensive],
            tiers: [
                (value: 10.0),
                (value: 20.0),
                (value: 35.0),
            ],
        ),
        (
            id: "movement_speed",
            name: "+#% movement speed",
            stat: "movement_speed_increased",
            slots: [Support, Defensive],
            tiers: [
                (value: 0.05),
                (value: 0.10),
                (value: 0.18),
            ],
        ),
    ],
)
```

Существующие stat ID в проекте:
- `physical_damage_base/increased/more` — физ. урон
- `max_life_base/increased/more` — здоровье (+ `max_life_per_strength`)
- `max_mana_base/increased` — мана
- `movement_speed_base/increased/more` — скорость
- `projectile_speed_base/increased` — скорость снарядов
- `projectile_count` — количество снарядов (Sum)
- `crit_chance_base/increased` — шанс крита (Clamp 0-1)
- `crit_multiplier_base/increased` — множитель крита
- `strength_base/increased/more` — сила
